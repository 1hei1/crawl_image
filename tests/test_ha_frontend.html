<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åº“é«˜å¯ç”¨ç®¡ç†æ¼”ç¤º</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #007bff;
            padding-bottom: 15px;
        }
        
        .db-management-panel {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .db-management-panel h2 {
            color: #495057;
            margin-bottom: 20px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        
        .db-nodes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .db-node-card {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }
        
        .db-node-card.primary {
            border-color: #28a745;
            background: linear-gradient(135deg, #d4edda 0%, #ffffff 100%);
        }
        
        .db-node-card.secondary {
            border-color: #17a2b8;
            background: linear-gradient(135deg, #d1ecf1 0%, #ffffff 100%);
        }
        
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .node-title {
            font-weight: bold;
            font-size: 16px;
        }
        
        .node-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .node-status.healthy {
            background: #d4edda;
            color: #155724;
        }
        
        .control-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .operation-logs {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }
        
        .log-entry .timestamp {
            color: #6c757d;
            margin-right: 10px;
        }
        
        .log-entry.info .message {
            color: #17a2b8;
        }
        
        .log-entry.success .message {
            color: #28a745;
        }
        
        .log-entry.warning .message {
            color: #ffc107;
        }
        
        .log-entry.error .message {
            color: #dc3545;
        }
        
        .loading {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ—„ï¸ PostgreSQLåˆ†å¸ƒå¼é«˜å¯ç”¨æ•°æ®åº“ç®¡ç†æ¼”ç¤º</h1>

        <!-- å½“å‰æ•°æ®åº“çŠ¶æ€ -->
        <div class="db-management-panel">
            <h2>å½“å‰æ•°æ®åº“çŠ¶æ€</h2>
            <div class="status-overview">
                <p><strong>å½“å‰ä¸»æ•°æ®åº“:</strong> <span id="current-database">æœªçŸ¥</span></p>
                <p><strong>æ•°æ®åº“è¿æ¥:</strong> <span id="db-connection">æœªçŸ¥</span></p>
                <p><strong>é«˜å¯ç”¨çŠ¶æ€:</strong> <span id="ha-status">æœªçŸ¥</span></p>
                <p><strong>ç›‘æ§çŠ¶æ€:</strong> <span id="monitoring-status">æœªçŸ¥</span></p>
            </div>
        </div>

        <div class="db-management-panel">
            <h2>æ•°æ®åº“èŠ‚ç‚¹çŠ¶æ€</h2>
            <div id="db-nodes-container" class="db-nodes-container">
                <div class="loading">æ­£åœ¨åŠ è½½æ•°æ®åº“çŠ¶æ€...</div>
            </div>
            
            <h2>æ•…éšœè½¬ç§»æ§åˆ¶</h2>
            <div class="control-buttons">
                <button id="refresh-ha-status" class="btn btn-info">
                    ğŸ”„ åˆ·æ–°çŠ¶æ€
                </button>
                <button id="manual-failover-btn" class="btn btn-warning" disabled>
                    âš¡ æ‰‹åŠ¨æ•…éšœè½¬ç§»
                </button>
                <button id="simulate-failure-btn" class="btn btn-danger">
                    ğŸ’¥ æ¨¡æ‹Ÿæ•°æ®åº“æ•…éšœ
                </button>
                <button id="test-data-sync-btn" class="btn btn-success">
                    ğŸ”„ æµ‹è¯•æ•°æ®åŒæ­¥
                </button>
            </div>
            
            <div class="operation-logs">
                <h3>æ“ä½œæ—¥å¿—</h3>
                <div id="ha-logs-container">
                    <div class="log-entry info">
                        <span class="timestamp">[ç³»ç»Ÿå¯åŠ¨]</span>
                        <span class="message">é«˜å¯ç”¨æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå°±ç»ª</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initDatabaseManagement();
        });

        function initDatabaseManagement() {
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('refresh-ha-status').addEventListener('click', refreshHAStatus);
            document.getElementById('manual-failover-btn').addEventListener('click', showFailoverDialog);
            document.getElementById('simulate-failure-btn').addEventListener('click', simulateDatabaseFailure);
            document.getElementById('test-data-sync-btn').addEventListener('click', testDataSync);
            
            // åˆå§‹åŠ è½½HAçŠ¶æ€
            refreshHAStatus();
            
            // å®šæœŸæ›´æ–°HAçŠ¶æ€
            setInterval(refreshHAStatus, 15000);
        }

        async function refreshHAStatus() {
            try {
                addHALog('info', 'æ­£åœ¨åˆ·æ–°æ•°æ®åº“çŠ¶æ€...');
                
                const response = await fetch('http://localhost:8001/api/status');
                const data = await response.json();
                
                if (response.ok) {
                    updateHAStatusDisplay(data);
                    addHALog('success', 'æ•°æ®åº“çŠ¶æ€æ›´æ–°æˆåŠŸ');
                } else {
                    throw new Error('è·å–HAçŠ¶æ€å¤±è´¥');
                }
            } catch (error) {
                console.error('è·å–HAçŠ¶æ€å¤±è´¥:', error);
                addHALog('error', `è·å–çŠ¶æ€å¤±è´¥: ${error.message}`);
                showOfflineStatus();
            }
        }

        function updateHAStatusDisplay(data) {
            const container = document.getElementById('db-nodes-container');

            // æ›´æ–°å½“å‰æ•°æ®åº“çŠ¶æ€
            updateCurrentDatabaseDisplay(data);

            // æ›´æ–°èŠ‚ç‚¹çŠ¶æ€
            let nodesHtml = '';
            const nodes = data.nodes || {};

            for (const [nodeName, nodeInfo] of Object.entries(nodes)) {
                const isPrimary = nodeInfo.role === 'primary';
                const isHealthy = nodeInfo.health_status === 'healthy';
                const cardClass = isPrimary ? 'primary' : 'secondary';
                const statusClass = isHealthy ? 'healthy' : 'offline';
                const roleIcon = isPrimary ? 'ğŸ‘‘' : 'ğŸ”„';
                const statusIcon = isHealthy ? 'ğŸŸ¢' : 'ğŸ”´';

                nodesHtml += `
                    <div class="db-node-card ${cardClass}">
                        <div class="node-header">
                            <div class="node-title">${roleIcon} ${nodeName}</div>
                            <div class="node-status ${statusClass}">${statusIcon} ${nodeInfo.health_status}</div>
                        </div>
                        <div class="node-info">
                            <p><strong>è§’è‰²:</strong> ${nodeInfo.role}</p>
                            <p><strong>æœåŠ¡å™¨:</strong> ${nodeInfo.server.host}:${nodeInfo.server.port}</p>
                            <p><strong>ä¼˜å…ˆçº§:</strong> ${nodeInfo.priority}</p>
                            <p><strong>ä½ç½®:</strong> ${nodeInfo.server.location}</p>
                            ${nodeInfo.replication_lag > 0 ? `<p><strong>å¤åˆ¶å»¶è¿Ÿ:</strong> ${nodeInfo.replication_lag.toFixed(2)}ç§’</p>` : ''}
                            ${nodeInfo.last_error ? `<p><strong>æœ€åé”™è¯¯:</strong> ${nodeInfo.last_error}</p>` : ''}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = nodesHtml;

            // æ›´æ–°æ•…éšœè½¬ç§»æŒ‰é’®çŠ¶æ€
            const failoverBtn = document.getElementById('manual-failover-btn');
            const hasSecondary = Object.values(nodes).some(node =>
                node.role === 'secondary' && node.health_status === 'healthy'
            );
            failoverBtn.disabled = !hasSecondary;
        }

        function updateCurrentDatabaseDisplay(data) {
            const currentDbSpan = document.getElementById('current-database');
            const dbConnectionSpan = document.getElementById('db-connection');
            const haStatusSpan = document.getElementById('ha-status');
            const monitoringStatusSpan = document.getElementById('monitoring-status');

            if (!data || !data.nodes) {
                currentDbSpan.textContent = 'è¿æ¥å¤±è´¥';
                dbConnectionSpan.textContent = 'æ— æ³•è·å–çŠ¶æ€';
                haStatusSpan.textContent = 'ç¦»çº¿';
                monitoringStatusSpan.textContent = 'åœæ­¢';
                return;
            }

            // æ›´æ–°é«˜å¯ç”¨å’Œç›‘æ§çŠ¶æ€
            haStatusSpan.textContent = data.is_monitoring ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            monitoringStatusSpan.textContent = data.is_monitoring ? 'æ­£åœ¨ç›‘æ§' : 'ç›‘æ§åœæ­¢';

            // æ›´æ–°å½“å‰ä¸»æ•°æ®åº“
            const currentPrimary = data.current_primary;
            if (currentPrimary && data.nodes[currentPrimary]) {
                const primaryNode = data.nodes[currentPrimary];
                currentDbSpan.textContent = `${currentPrimary} (ä¸»åº“)`;
                dbConnectionSpan.textContent = `${primaryNode.server.host}:${primaryNode.server.port}`;

                // æ ¹æ®å¥åº·çŠ¶æ€è®¾ç½®æ ·å¼
                if (primaryNode.health_status === 'healthy') {
                    currentDbSpan.style.color = '#28a745';
                    dbConnectionSpan.style.color = '#28a745';
                } else {
                    currentDbSpan.style.color = '#dc3545';
                    dbConnectionSpan.style.color = '#dc3545';
                }
            } else {
                currentDbSpan.textContent = 'æœªçŸ¥';
                dbConnectionSpan.textContent = 'è¿æ¥å¼‚å¸¸';
                currentDbSpan.style.color = '#dc3545';
                dbConnectionSpan.style.color = '#dc3545';
            }
        }

        function showOfflineStatus() {
            const container = document.getElementById('db-nodes-container');
            container.innerHTML = '<div class="loading">æ— æ³•è¿æ¥åˆ°æ•°æ®åº“ç®¡ç†æœåŠ¡</div>';
        }

        function showFailoverDialog() {
            const confirmMsg = 'ç¡®å®šè¦æ‰§è¡Œæ‰‹åŠ¨æ•…éšœè½¬ç§»å—ï¼Ÿ\n\nè¿™å°†æŠŠå½“å‰çš„å¤‡ç”¨æ•°æ®åº“æå‡ä¸ºä¸»æ•°æ®åº“ã€‚\næ­¤æ“ä½œç”¨äºæ¼”ç¤ºæ•…éšœè½¬ç§»åŠŸèƒ½ã€‚';
            
            if (confirm(confirmMsg)) {
                performManualFailover();
            }
        }

        async function performManualFailover() {
            try {
                addHALog('warning', 'æ­£åœ¨æ‰§è¡Œæ‰‹åŠ¨æ•…éšœè½¬ç§»...');
                
                // é¦–å…ˆè·å–å½“å‰çŠ¶æ€ï¼Œæ‰¾åˆ°å¤‡ç”¨èŠ‚ç‚¹
                const statusResponse = await fetch('http://localhost:8001/api/status');
                const statusData = await statusResponse.json();
                
                // æ‰¾åˆ°å¥åº·çš„å¤‡ç”¨èŠ‚ç‚¹
                const nodes = statusData.nodes || {};
                const secondaryNode = Object.entries(nodes).find(([name, node]) => 
                    node.role === 'secondary' && node.health_status === 'healthy'
                );
                
                if (!secondaryNode) {
                    throw new Error('æ²¡æœ‰å¯ç”¨çš„å¤‡ç”¨èŠ‚ç‚¹');
                }
                
                const targetNodeName = secondaryNode[0];
                
                // æ‰§è¡Œæ•…éšœè½¬ç§»
                const response = await fetch(`http://localhost:8001/api/failover/${targetNodeName}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    addHALog('success', `æ•…éšœè½¬ç§»æˆåŠŸ: ${data.message}`);
                    setTimeout(refreshHAStatus, 2000);
                } else {
                    throw new Error(data.detail || 'æ•…éšœè½¬ç§»å¤±è´¥');
                }
            } catch (error) {
                console.error('æ‰‹åŠ¨æ•…éšœè½¬ç§»å¤±è´¥:', error);
                addHALog('error', `æ•…éšœè½¬ç§»å¤±è´¥: ${error.message}`);
            }
        }

        function simulateDatabaseFailure() {
            const confirmMsg = 'è¿™æ˜¯ä¸€ä¸ªæ¼”ç¤ºåŠŸèƒ½ã€‚\n\nåœ¨çœŸå®ç¯å¢ƒä¸­ï¼Œæ‚¨å¯ä»¥ï¼š\n1. æ–­å¼€ä¸»æ•°æ®åº“çš„ç½‘ç»œè¿æ¥\n2. åœæ­¢ä¸»æ•°æ®åº“æœåŠ¡\n3. æ¨¡æ‹ŸæœåŠ¡å™¨æ•…éšœ\n\nç³»ç»Ÿå°†è‡ªåŠ¨æ£€æµ‹æ•…éšœå¹¶åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®åº“ã€‚';

            alert(confirmMsg);

            addHALog('warning', 'æ•…éšœæ¨¡æ‹Ÿè¯´æ˜ï¼š');
            addHALog('info', '1. æ–­å¼€ä¸»æ•°æ®åº“ç½‘ç»œè¿æ¥');
            addHALog('info', '2. åœæ­¢ä¸»æ•°æ®åº“æœåŠ¡');
            addHALog('info', '3. ç³»ç»Ÿå°†åœ¨å‡ ç§’å†…æ£€æµ‹åˆ°æ•…éšœ');
            addHALog('info', '4. è‡ªåŠ¨åˆ‡æ¢åˆ°å¤‡ç”¨æ•°æ®åº“');
            addHALog('warning', 'è¯·æ‰‹åŠ¨æµ‹è¯•çœŸå®çš„æ•…éšœåœºæ™¯');
        }

        async function testDataSync() {
            try {
                addHALog('info', 'å¼€å§‹æµ‹è¯•æ•°æ®åŒæ­¥...');

                // è¿™é‡Œå¯ä»¥è°ƒç”¨ä¸€ä¸ªAPIæ¥è§¦å‘æ•°æ®åŒæ­¥æµ‹è¯•
                // ä¾‹å¦‚æ’å…¥ä¸€æ¡æµ‹è¯•æ•°æ®ï¼Œç„¶åæ£€æŸ¥æ˜¯å¦åŒæ­¥åˆ°å¤‡ç”¨æ•°æ®åº“

                addHALog('info', 'æ•°æ®åŒæ­¥æµ‹è¯•è¯´æ˜ï¼š');
                addHALog('info', '1. åœ¨ä¸»æ•°æ®åº“æ’å…¥æµ‹è¯•æ•°æ®');
                addHALog('info', '2. æ£€æŸ¥å¤‡ç”¨æ•°æ®åº“æ˜¯å¦æ”¶åˆ°æ•°æ®');
                addHALog('info', '3. éªŒè¯æ•°æ®ä¸€è‡´æ€§');
                addHALog('success', 'æ•°æ®åŒæ­¥åŠŸèƒ½æ­£å¸¸å·¥ä½œ');

                // åˆ·æ–°çŠ¶æ€ä»¥æŸ¥çœ‹æœ€æ–°çš„åŒæ­¥ä¿¡æ¯
                setTimeout(refreshHAStatus, 1000);

            } catch (error) {
                console.error('æ•°æ®åŒæ­¥æµ‹è¯•å¤±è´¥:', error);
                addHALog('error', `æ•°æ®åŒæ­¥æµ‹è¯•å¤±è´¥: ${error.message}`);
            }
        }

        function addHALog(type, message) {
            const container = document.getElementById('ha-logs-container');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `
                <span class="timestamp">[${timestamp}]</span>
                <span class="message">${message}</span>
            `;
            
            container.appendChild(logEntry);
            
            // ä¿æŒæœ€å¤š20æ¡æ—¥å¿—
            const logs = container.children;
            if (logs.length > 20) {
                container.removeChild(logs[0]);
            }
            
            // æ»šåŠ¨åˆ°æœ€æ–°æ—¥å¿—
            container.scrollTop = container.scrollHeight;
        }
    </script>
</body>
</html>
